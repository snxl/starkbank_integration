<h1 align="center">
  stark bank integration
</h1>

The objective of this repos is the integration with stark bank to issue 8 - 12 invoices every 3 hour and receive the webhook event after that to register a transfer with the value of invoice.


### 🐍️ Project structure

```
.
├── README.md -> this file
├── go.mod -> project config
├── go.sum -> version deps
├── Dockerfile -> build the image of this project
├── docker-compose.yml -> build the required images
├── src
│   ├── main.go [file] entrypoint golang
│   ├── application
│   │   ├── docs -> [folder] swagger files
│   │   ├── handler -> [folder] all the handlers
│   │   ├── job -> [folder] cron jobs
│   │   ├── queue -> [folder] consumers of the application
│   │   └── server -> [folder] server config... like gin/swag
│   │
│   ├── config
│   │   ├── keys -> [folder] envs factory
│   │   ├── redis.go -> [file] redis conn
│   │   └── asynq.go -> [file] asynq conn
│   │
│   ├── core
│   │   ├── client
│   │   │  └── context
│   │   │       ├── context_client.go -> [file] interface of client
│   │   │       └── sdk_client.go -> [file] implementation of the interface
│   │   ├── dto -> [folder] object relational mapping
│   │   ├── repository
│   │   │   └── context
│   │   │       ├── context_repository.go -> [file] interface of repository
│   │   │       └── cache_repository.go -> [file] implementation of the interface
│   │   └── usecase
│   │       └── context
│   │           ├── usecase.go -> [file] business rule of the context
│   │           └── cache_repository.go -> [file] dto of the usecase
│   │
    └── shared
│       └── constant -> [folder] constants of the project
└── ...
```


### ⚠️ Before you go

You'll need to generate the ECDSA keys! To do that use the comand bellow

```bash
    openssl ecparam -name secp256k1 -genkey -out privateKey.pem
    openssl ec -in privateKey.pem -pubout -out publicKey.pem
```

After created your ECDSA keys go to stark bank sandbox

    -> integrações
        -> projetos
            -> novo projeto

Upload your public key generated before and named your project.

Copy your project id and go to your .env

Set your .env like sample.env

```bash
# setting .env
REDIS_URL=redis:6379
REDIS_PASSWORD=123456

STARK_BANK_PROJECT_ID="1234567899518462357"
STARK_BANK_PRIVATE_KEY="-----BEGIN EC PARAMETERS-----\nBgUrgQQACg==\n-----END EC PARAMETERS-----\n-----BEGIN EC PRIVATE KEY-----\nMHQCAQEEIDgByHFURrZRsIFeaOREOXiWfarLOnbejv7oofM9vh9FoAcGBSuBBAAK\noUQDQgAEyF3Zx5S4NEINR5MtnDN0NCFk9Y3xA15DWJCmjEOTuAyL4o2pLuPnYURj\nXx+rF6daDpfHSsI55bH9QirV06p0Nw==\n-----END EC PRIVATE KEY-----"
STARK_BANK_ENVIRONMENT="sandbox"
```

Lastly we'll configure our webhook

expose your localhost 8080 with this command

`ssh -R 80:localhost:8080 serveo.net`

copy the link generated by that and add

`/v1/webhook/starkbank`

After in stark bank sandbox

    -> integrações
        -> webhooks
            -> novo webhhok

put your url and subscribe to invoice

### 💿 Run the project

Just do

`docker-compose up -d`

### 👾 Some features

this application has 

Queue monitor
`/monitor`
![alt text](.github/asynqui.png)

webhook expect doc
`http://localhost:8080/swagger/index.html`
![alt text](.github/swagger.png)

prometheus metrics
`/metrics`
![alt text](.github/prometheus.png)