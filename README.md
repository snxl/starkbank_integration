<h1 align="center">
  stark bank integration
</h1>

The objective of this repos is the integration with stark bank to issue 8 - 12 invoices every 3 hour and receive the webhook event after that to register a transfer with the value of invoice.


### ðŸï¸ Project structure

```
.
â”œâ”€â”€ README.md -> this file
â”œâ”€â”€ go.mod -> project config
â”œâ”€â”€ go.sum -> version deps
â”œâ”€â”€ Dockerfile -> build the image of this project
â”œâ”€â”€ docker-compose.yml -> build the required images
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ main.go [file] entrypoint golang
â”‚   â”œâ”€â”€ application
â”‚   â”‚   â”œâ”€â”€ docs -> [folder] swagger files
â”‚   â”‚   â”œâ”€â”€ handler -> [folder] all the handlers
â”‚   â”‚   â”œâ”€â”€ job -> [folder] cron jobs
â”‚   â”‚   â”œâ”€â”€ queue -> [folder] consumers of the application
â”‚   â”‚   â””â”€â”€ server -> [folder] server config... like gin/swag
â”‚   â”‚
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ keys -> [folder] envs factory
â”‚   â”‚   â”œâ”€â”€ redis.go -> [file] redis conn
â”‚   â”‚   â””â”€â”€ asynq.go -> [file] asynq conn
â”‚   â”‚
â”‚   â”œâ”€â”€ core
â”‚   â”‚   â”œâ”€â”€ client
â”‚   â”‚   â”‚  â””â”€â”€ context
â”‚   â”‚   â”‚       â”œâ”€â”€ context_client.go -> [file] interface of client
â”‚   â”‚   â”‚       â””â”€â”€ sdk_client.go -> [file] implementation of the interface
â”‚   â”‚   â”œâ”€â”€ dto -> [folder] object relational mapping
â”‚   â”‚   â”œâ”€â”€ repository
â”‚   â”‚   â”‚   â””â”€â”€ context
â”‚   â”‚   â”‚       â”œâ”€â”€ context_repository.go -> [file] interface of repository
â”‚   â”‚   â”‚       â””â”€â”€ cache_repository.go -> [file] implementation of the interface
â”‚   â”‚   â””â”€â”€ usecase
â”‚   â”‚       â””â”€â”€ context
â”‚   â”‚           â”œâ”€â”€ usecase.go -> [file] business rule of the context
â”‚   â”‚           â””â”€â”€ cache_repository.go -> [file] dto of the usecase
â”‚   â”‚
    â””â”€â”€ shared
â”‚       â””â”€â”€ constant -> [folder] constants of the project
â””â”€â”€ ...
```


### âš ï¸ Before you go

You'll need to generate the ECDSA keys! To do that use the comand bellow

```bash
    openssl ecparam -name secp256k1 -genkey -out privateKey.pem
    openssl ec -in privateKey.pem -pubout -out publicKey.pem
```

After created your ECDSA keys go to stark bank sandbox

    -> integraÃ§Ãµes
        -> projetos
            -> novo projeto

Upload your public key generated before and named your project.

Copy your project id and go to your .env

Set your .env like sample.env

```bash
# setting .env
REDIS_URL=redis:6379
REDIS_PASSWORD=123456

STARK_BANK_PROJECT_ID="1234567899518462357"
STARK_BANK_PRIVATE_KEY="-----BEGIN EC PARAMETERS-----\nBgUrgQQACg==\n-----END EC PARAMETERS-----\n-----BEGIN EC PRIVATE KEY-----\nMHQCAQEEIDgByHFURrZRsIFeaOREOXiWfarLOnbejv7oofM9vh9FoAcGBSuBBAAK\noUQDQgAEyF3Zx5S4NEINR5MtnDN0NCFk9Y3xA15DWJCmjEOTuAyL4o2pLuPnYURj\nXx+rF6daDpfHSsI55bH9QirV06p0Nw==\n-----END EC PRIVATE KEY-----"
STARK_BANK_ENVIRONMENT="sandbox"
```

Lastly we'll configure our webhook

expose your localhost 8080 with this command

`ssh -R 80:localhost:8080 serveo.net`

copy the link generated by that and add

`/v1/webhook/starkbank`

After in stark bank sandbox

    -> integraÃ§Ãµes
        -> webhooks
            -> novo webhhok

put your url and subscribe to invoice

### ðŸ’¿ Run the project

Just do

`docker-compose up -d`

### ðŸ‘¾ Some features

this application has 

Queue monitor
`/monitor`
![alt text](.github/asynqui.png)

webhook expect doc
`http://localhost:8080/swagger/index.html`
![alt text](.github/swagger.png)

prometheus metrics
`/metrics`
![alt text](.github/prometheus.png)